<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ã‰tape</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="container">
    <h2 id="question"></h2>
    <h3 id="explication"></h3>
    <p class="info">ğŸ” Trouve et scanne le QR code pour passer Ã  l'Ã©tape suivante.</p>
    <button class="btn" id="scanBtn">ğŸ“· Scanner le QR</button>
    <div id="qr-reader" style="width:100%; margin-top:1rem;"></div>
    <audio id="musique" loop></audio>
  </div>

  <script src="data.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const id = parseInt(params.get("id"), 10);
      const etapeMax = parseInt(localStorage.getItem("etape_max") || "1", 10);

      const questionEl = document.getElementById("question");
      const explicationEl = document.getElementById("explication");
      const body = document.body;
      const musiqueEl = document.getElementById("musique");
      const scanBtn = document.getElementById("scanBtn");

      if (!etapes[id]) {
        questionEl.textContent = "Ã‰tape inconnue";
      } else if (id > etapeMax) {
        document.body.innerHTML = `
          <div class="container">
            <h2>â›” AccÃ¨s refusÃ©</h2>
            <p>Tu dois rÃ©soudre les Ã©tapes prÃ©cÃ©dentes.</p>
          </div>`;
      } else {
        const etape = etapes[id];
        questionEl.textContent = `Ã‰tape ${id} â€“ ${etape.question}`;
        explicationEl.innerHTML = `${etape.explication}`;


  

        if(localStorage.getItem("musiqueDemarree") === "true" && etape.music) {
          musiqueEl.src = etape.music;
          musiqueEl.play().catch(err => console.log("Lecture musique sur Ã©tape :", err));
        }

        scanBtn.addEventListener("click", () => {
          const html5QrCode = new Html5Qrcode("qr-reader");
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
              window.location.href = decodedText;
              html5QrCode.stop();
            },
            () => {}
          ).catch(err => console.error(err));
        });
      }
    });
  </script>
</body>
</html>